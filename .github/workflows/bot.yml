name: bot

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  CARGO_TERM_COLOR: always
  CARGO_LOCA: "Cargo.toml"

permissions:
  contents: write

on:
  workflow_dispatch:
  push:
    branches:
      - "main"

jobs:
  pre:
    runs-on: ubuntu-latest
    outputs:
      cargo_loc: ${{ env.CARGO_LOCA }}
    steps:
      - run: echo "Bypass Restriction"

  ready:
    needs:
      - pre
    uses: AUTOM77/Rust-Actions/.github/workflows/cargo-version.yml@main
    with:
      cargo_path: ${{ needs.pre.outputs.cargo_loc }}
    secrets: inherit

  push:
    needs:
      - ready
    uses: AUTOM77/Rust-Actions/.github/workflows/push-tag.yml@main
    with:
      version: v${{ needs.ready.outputs.version }}
    secrets: inherit

  publish:
    needs:
      - push
    uses: AUTOM77/Rust-Actions/.github/workflows/push-release.yml@main
    with:
      push_tag: ${{ needs.push.outputs.tag }}
      note: add ${{ needs.push.outputs.tag }}
    secrets: inherit

  cross-release:
    uses: AUTOM77/Rust-Actions/.github/workflows/cross-compile.yml@main
    secrets: inherit
    strategy:
      matrix:
        include:
          -
            target: 'x86_64-unknown-linux-musl'
            platform: 'ubuntu-latest'
          -
            target: 'x86_64-unknown-linux-gnu'
            platform: 'ubuntu-latest'
          - target: aarch64-unknown-linux-musl
            platform: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            platform: ubuntu-latest
          - target: aarch64-apple-darwin
            platform: macos-latest
          -
            target: 'x86_64-apple-darwin'
            platform: 'macos-latest'
          -
            target: 'x86_64-pc-windows-gnu'
            platform: 'windows-latest'
          -
            target: 'x86_64-pc-windows-msvc'
            platform: 'windows-latest'
    with:
      pushed_tag: "v0.1.1"
      target: ${{ matrix.target }}
      platform: ${{ matrix.platform }}
      binary: "rfbs"
